<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HOD Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Firebase Libraries -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, where, orderBy, getDocs, doc, deleteDoc, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAOFDLOYDRdSZfwprsvs_ena_3X2D0BHjw",
            authDomain: "student-management-syste-27e33.firebaseapp.com",
            projectId: "student-management-syste-27e33",
            storageBucket: "student-management-syste-27e33.appspot.com",
            messagingSenderId: "536854876751",
            appId: "1:536854876751:web:adf88ef74dfc76cea903a",
            measurementId: "G-FKZJL4HLZZ"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        let allAttendanceRecords = [];
        let allTeachers = {};
        let attendanceChart = null;

        const dashboardView = document.getElementById('dashboardView');

        // --- COLLECTIONS ---
        const teachersCollection = collection(db, "teachers");
        const departmentsCollection = collection(db, "departments");
        const attendanceCollection = collection(db, "attendance");

        // --- PAGE LOAD LOGIC ---
        window.addEventListener('DOMContentLoaded', () => {
            // Directly show the dashboard on page load
            showDashboard();
        });

        function showDashboard() {
            dashboardView.classList.remove('hidden');
            loadInitialData();
        }
        
        function loadInitialData() {
            // Load Teachers for filter and management
            onSnapshot(teachersCollection, (snapshot) => {
                const teacherFilter = document.getElementById('teacherFilter');
                const teacherList = document.getElementById('teacher-list');
                teacherFilter.innerHTML = '<option value="all">All Teachers</option>';
                teacherList.innerHTML = '';
                allTeachers = {};
                snapshot.forEach((doc) => {
                    const teacher = { id: doc.id, ...doc.data() };
                    allTeachers[doc.id] = teacher;

                    const option = document.createElement('option');
                    option.value = doc.id;
                    option.textContent = `${teacher.name} (${teacher.subject})`;
                    teacherFilter.appendChild(option);
                    
                    const li = document.createElement('li');
                    li.className = 'flex justify-between items-center p-2 bg-gray-50 rounded';
                    li.innerHTML = `<span>${teacher.name} - ${teacher.subject} (Div: ${teacher.division})</span><button onclick="deleteTeacher('${doc.id}')" class="text-red-500 hover:text-red-700">Delete</button>`;
                    teacherList.appendChild(li);
                });
            });

            // Load Departments for filter and management
            onSnapshot(departmentsCollection, (snapshot) => {
                const departmentFilter = document.getElementById('departmentFilter');
                const departmentList = document.getElementById('department-list');
                departmentFilter.innerHTML = '<option value="all">All Departments</option>';
                departmentList.innerHTML = '';
                 snapshot.forEach((doc) => {
                    const department = { id: doc.id, ...doc.data() };
                    const option = document.createElement('option');
                    option.value = department.name;
                    option.textContent = department.name;
                    departmentFilter.appendChild(option);
                     
                    const li = document.createElement('li');
                    li.className = 'flex justify-between items-center p-2 bg-gray-50 rounded';
                    li.innerHTML = `<span>${department.name}</span><button onclick="deleteDepartment('${doc.id}')" class="text-red-500 hover:text-red-700">Delete</button>`;
                    departmentList.appendChild(li);
                });
            });

            // Load all attendance records
            const q = query(attendanceCollection, orderBy("timestamp", "desc"));
            onSnapshot(q, (querySnapshot) => {
                allAttendanceRecords = [];
                querySnapshot.forEach((doc) => {
                    allAttendanceRecords.push({ id: doc.id, ...doc.data() });
                });
                filterRecords();
            });
        }

        // --- CRUD for Teachers and Departments ---
        document.getElementById('add-teacher-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const name = document.getElementById('new-teacher-name').value;
            const subject = document.getElementById('new-teacher-subject').value;
            const division = document.getElementById('new-teacher-division').value;
            await addDoc(teachersCollection, { name, subject, division });
            e.target.reset();
        });

        document.getElementById('add-department-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const name = document.getElementById('new-department-name').value;
            await addDoc(departmentsCollection, { name });
            e.target.reset();
        });
        
        window.deleteTeacher = async (id) => {
            if(confirm('Are you sure you want to delete this teacher?')) {
                await deleteDoc(doc(db, "teachers", id));
            }
        }
        
        window.deleteDepartment = async (id) => {
            if(confirm('Are you sure you want to delete this department?')) {
                await deleteDoc(doc(db, "departments", id));
            }
        }

        function renderAttendance(records) {
            const attendanceList = document.getElementById('attendanceList');
             const placeholder = document.getElementById('detailsPlaceholder');
            const studentDetails = document.getElementById('studentDetails');
            attendanceList.innerHTML = '';

            if (records.length === 0) {
                attendanceList.innerHTML = '<p class="text-gray-500">No records match filter.</p>';
                 placeholder.classList.remove('hidden');
                studentDetails.classList.add('hidden');
                return;
            }

            records.forEach(record => {
                const recordDiv = document.createElement('div');
                recordDiv.className = 'p-3 mb-2 bg-gray-50 rounded-lg cursor-pointer hover:bg-orange-100 border border-gray-200';
                recordDiv.innerHTML = `<h4 class="font-semibold text-gray-800">${record.studentName}</h4><p class="text-sm text-gray-500">Div: ${record.division} | ${new Date(record.timestamp.toDate()).toLocaleString()}</p>`;
                recordDiv.onclick = () => showDetails(record.id);
                attendanceList.appendChild(recordDiv);
            });
        }

        window.showDetails = function(recordId) {
            const record = allAttendanceRecords.find(r => r.id === recordId);
            if (!record) return;
            
            document.getElementById('detailName').innerText = record.studentName || 'N/A';
            document.getElementById('detailPrn').innerText = record.prn || 'N/A';
            document.getElementById('detailDepartment').innerText = record.department || 'N/A';
            document.getElementById('detailClass').innerText = record.class || 'N/A';
            document.getElementById('detailLecture').innerText = record.lecture || 'N/A';
            document.getElementById('detailLectureDate').innerText = record.lectureDate || 'N/A';
            document.getElementById('detailTime').innerText = new Date(record.timestamp.toDate()).toLocaleString();
            document.getElementById('detailLocation').innerHTML = `<a href="https://www.google.com/maps?q=${record.location.lat},${record.location.lon}" target="_blank" class="text-orange-500 hover:underline">${record.locationName || 'View on Map'}</a>`;
            document.getElementById('detailDivision').innerText = record.division || 'N/A';
            
            const teacher = allTeachers[record.teacherId];
            document.getElementById('detailTeacher').innerText = teacher ? `${teacher.name} (${teacher.subject})` : 'Unknown';

            document.getElementById('detailsPlaceholder').classList.add('hidden');
            document.getElementById('studentDetails').classList.remove('hidden');
        }

        function updateAnalytics(records) {
            const ctx = document.getElementById('attendanceChart').getContext('2d');
            const attendanceByDay = {};

            records.forEach(record => {
                const date = new Date(record.timestamp.toDate()).toLocaleDateString();
                attendanceByDay[date] = (attendanceByDay[date] || 0) + 1;
            });

            const labels = Object.keys(attendanceByDay).sort((a,b) => new Date(a.split('/').reverse().join('-')) - new Date(b.split('/').reverse().join('-')));
            const data = labels.map(label => attendanceByDay[label]);

            if(attendanceChart) {
                attendanceChart.destroy();
            }

            attendanceChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Students Present',
                        data: data,
                        backgroundColor: 'rgba(249, 115, 22, 0.6)',
                        borderColor: 'rgba(249, 115, 22, 1)',
                        borderWidth: 1
                    }]
                },
                options: { scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } } }
            });
        }
        
        function filterRecords() {
            const selectedTeacher = document.getElementById('teacherFilter').value;
            const selectedDivision = document.getElementById('divisionFilter').value;
            const selectedDepartment = document.getElementById('departmentFilter').value;
            const selectedClass = document.getElementById('classFilter').value;
            
            let filteredRecords = allAttendanceRecords;

            if (selectedTeacher !== 'all') {
                filteredRecords = filteredRecords.filter(r => r.teacherId === selectedTeacher);
            }
            if (selectedDivision !== 'all') {
                filteredRecords = filteredRecords.filter(r => r.division === selectedDivision);
            }
            if (selectedDepartment !== 'all') {
                filteredRecords = filteredRecords.filter(r => r.department === selectedDepartment);
            }
            if (selectedClass !== 'all') {
                filteredRecords = filteredRecords.filter(r => r.class === selectedClass);
            }
            renderAttendance(filteredRecords);
            updateAnalytics(filteredRecords);
        }
        
        window.filterRecords = filterRecords;

        document.getElementById('exportButton').addEventListener('click', () => {
             const selectedTeacher = document.getElementById('teacherFilter').value;
            const selectedDivision = document.getElementById('divisionFilter').value;
            const selectedDepartment = document.getElementById('departmentFilter').value;
            const selectedClass = document.getElementById('classFilter').value;
            
            let recordsToExport = allAttendanceRecords;

            if (selectedTeacher !== 'all') {
                recordsToExport = recordsToExport.filter(r => r.teacherId === selectedTeacher);
            }
            if (selectedDivision !== 'all') {
                recordsToExport = recordsToExport.filter(r => r.division === selectedDivision);
            }
            if (selectedDepartment !== 'all') {
                recordsToExport = recordsToExport.filter(r => r.department === selectedDepartment);
            }
            if (selectedClass !== 'all') {
                recordsToExport = recordsToExport.filter(r => r.class === selectedClass);
            }
            
            if (recordsToExport.length === 0) {
                alert("No data to export.");
                return;
            }

            const headers = ["Student Name", "PRN", "Department", "Class", "Division", "Teacher", "Marked Date", "Marked Time", "Lecture Number", "Lecture Date", "Location"];
            const rows = recordsToExport.map(record => {
                const timestamp = record.timestamp.toDate();
                const teacher = allTeachers[record.teacherId];
                const sanitize = (str) => `"${(str || '').toString().replace(/"/g, '""')}"`;

                return [
                    sanitize(record.studentName),
                    sanitize(record.prn),
                    sanitize(record.department),
                    sanitize(record.class),
                    sanitize(record.division),
                    sanitize(teacher ? teacher.name : 'Unknown'),
                    sanitize(timestamp.toLocaleDateString()),
                    sanitize(timestamp.toLocaleTimeString()),
                    sanitize(record.lecture),
                    sanitize(record.lectureDate),
                    sanitize(record.locationName)
                ].join(',');
            });

            const csvContent = [headers.join(','), ...rows].join('\n');
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            if (link.download !== undefined) { 
                const url = URL.createObjectURL(blob);
                const filename = `attendance_export_${new Date().toISOString().split('T')[0]}.csv`;
                link.setAttribute("href", url);
                link.setAttribute("download", filename);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
        });

    </script>
</head>
<body class="bg-gray-100 font-sans">
    
    <!-- Dashboard View -->
    <div id="dashboardView" class="hidden container mx-auto p-4 md:p-8">
        <div class="flex justify-between items-center mb-6">
            <div>
                 <h1 class="text-4xl font-bold text-gray-800">HOD Dashboard</h1>
                 <p class="text-lg text-gray-600">Overall College Attendance View</p>
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
            <div>
                <label for="teacherFilter" class="block text-sm font-medium text-gray-700 mb-1">Filter by Teacher:</label>
                <select id="teacherFilter" onchange="filterRecords()" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-orange-500">
                    <option value="all">All Teachers</option>
                </select>
            </div>
             <div>
                <label for="divisionFilter" class="block text-sm font-medium text-gray-700 mb-1">Filter by Division:</label>
                <select id="divisionFilter" onchange="filterRecords()" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-orange-500">
                    <option value="all">All Divisions</option>
                    <option value="A">Division A</option>
                    <option value="B">Division B</option>
                    <option value="C">Division C</option>
                </select>
            </div>
            <div>
                <label for="departmentFilter" class="block text-sm font-medium text-gray-700 mb-1">Filter by Department:</label>
                <select id="departmentFilter" onchange="filterRecords()" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-orange-500">
                    <option value="all">All Departments</option>
                </select>
            </div>
             <div>
                <label for="classFilter" class="block text-sm font-medium text-gray-700 mb-1">Filter by Class:</label>
                <select id="classFilter" onchange="filterRecords()" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-orange-500">
                    <option value="all">All Classes</option>
                    <option value="FY BTech">FY BTech</option>
                    <option value="SY BTech">SY BTech</option>
                    <option value="TY BTech">TY BTech</option>
                    <option value="BTech">BTech</option>
                </select>
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
            <div class="md:col-span-1 bg-white rounded-2xl shadow-lg p-6">
                <h2 class="text-2xl font-bold text-gray-800 mb-4 border-b pb-2">Full Attendance Log</h2>
                <div id="attendanceList" class="max-h-96 overflow-y-auto"></div>
            </div>
            <div class="md:col-span-2 bg-white rounded-2xl shadow-lg p-6">
                 <h2 class="text-2xl font-bold text-gray-800 mb-4 border-b pb-2">Attendance Details</h2>
                 <div id="detailsPlaceholder" class="text-center py-12">
                     <p class="text-gray-500">Select a record from the log to see details.</p>
                 </div>
                 <div id="studentDetails" class="hidden space-y-3">
                     <p><strong>Name:</strong> <span id="detailName"></span></p>
                     <p><strong>PRN Number:</strong> <span id="detailPrn"></span></p>
                     <p><strong>Department:</strong> <span id="detailDepartment"></span></p>
                     <p><strong>Class:</strong> <span id="detailClass"></span></p>
                     <p><strong>Marked For:</strong> <span id="detailTeacher"></span></p>
                     <p><strong>Division:</strong> <span id="detailDivision"></span></p>
                     <p><strong>Marked At:</strong> <span id="detailTime"></span></p>
                     <p><strong>Location:</strong> <span id="detailLocation"></span></p>
                     <p><strong>Lecture:</strong> <span id="detailLecture"></span></p>
                     <p><strong>Lecture Date:</strong> <span id="detailLectureDate"></span></p>
                 </div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mt-8">
            <div class="bg-white rounded-2xl shadow-lg p-6">
                <h2 class="text-2xl font-bold text-gray-800 mb-4 border-b pb-2">College-Wide Analytics</h2>
                <canvas id="attendanceChart"></canvas>
            </div>
            <div class="bg-white rounded-2xl shadow-lg p-6">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <h3 class="text-xl font-bold text-gray-800 mb-3">Manage Teachers</h3>
                        <form id="add-teacher-form" class="space-y-2">
                            <input id="new-teacher-name" type="text" placeholder="Teacher Name" required class="w-full p-2 border rounded">
                            <input id="new-teacher-subject" type="text" placeholder="Subject" required class="w-full p-2 border rounded">
                             <select id="new-teacher-division" required class="w-full p-2 border rounded">
                                <option value="">Assign Division</option>
                                <option value="A">Division A</option>
                                <option value="B">Division B</option>
                                <option value="C">Division C</option>
                            </select>
                            <button type="submit" class="w-full bg-blue-500 text-white p-2 rounded hover:bg-blue-600">Add Teacher</button>
                        </form>
                        <ul id="teacher-list" class="mt-4 space-y-2 max-h-48 overflow-y-auto"></ul>
                    </div>
                     <div>
                        <h3 class="text-xl font-bold text-gray-800 mb-3">Manage Departments</h3>
                        <form id="add-department-form" class="space-y-2">
                            <input id="new-department-name" type="text" placeholder="Department Name" required class="w-full p-2 border rounded">
                            <button type="submit" class="w-full bg-blue-500 text-white p-2 rounded hover:bg-blue-600">Add Department</button>
                        </form>
                        <ul id="department-list" class="mt-4 space-y-2 max-h-48 overflow-y-auto"></ul>
                    </div>
                </div>
            </div>
        </div>
        <div class="mt-6 text-center">
            <button id="exportButton" class="bg-green-600 text-white font-bold py-3 px-8 rounded-lg hover:bg-green-700">
                Export Filtered Data to CSV
            </button>
        </div>
    </div>
</body>
</html>

