<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Attendance</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="manifest" href="manifest.json">
    <style>
        .gradient-bg {
            background: linear-gradient(-45deg, #ee7752, #e73c7e, #23a6d5, #23d5ab);
            background-size: 400% 400%;
            animation: gradient 15s ease infinite;
        }

        @keyframes gradient {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
    </style>
     <!-- Firebase Libraries -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, addDoc, query, where, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAOFDLOYDRdSZfwprsvs_ena_3X2D0BHjw",
            authDomain: "student-management-syste-27e33.firebaseapp.com",
            projectId: "student-management-syste-27e33",
            storageBucket: "student-management-syste-27e33.appspot.com",
            messagingSenderId: "536854876751",
            appId: "1:536854876751:web:adf88ef74dfc76cea903a",
            measurementId: "G-FKZJL4HLZZ"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        
        const studentsCollection = collection(db, "students");
        const attendanceCollection = collection(db, "attendance");
        const departmentsCollection = collection(db, "departments");

        let currentStudent = null;
        let linkParams = {};

        const loginView = document.getElementById('loginView');
        const registerView = document.getElementById('registerView');
        const dashboardView = document.getElementById('dashboardView');
        
        // --- PAGE LOAD LOGIC ---
        window.addEventListener('DOMContentLoaded', () => {
            const params = new URLSearchParams(window.location.search);
            const teacherId = params.get('teacherId');
            const lecture = params.get('lecture');
            const date = params.get('date');

            if (teacherId && lecture && date) {
                linkParams = { teacherId, lecture, date };
                console.log("Attendance link detected:", linkParams);
            }

            // Check if student is "logged in" from local storage for persistence
            const loggedInStudent = localStorage.getItem('currentStudent');
            if (loggedInStudent) {
                currentStudent = JSON.parse(loggedInStudent);
                showDashboard();
            } else {
                showLogin();
            }
        });

        // --- NAVIGATION ---
        document.getElementById('showRegister').addEventListener('click', showRegister);
        document.getElementById('showLogin').addEventListener('click', showLogin);
        document.getElementById('logoutButton').addEventListener('click', logout);

        function showLogin() {
            loginView.classList.remove('hidden');
            registerView.classList.add('hidden');
            dashboardView.classList.add('hidden');
        }

        function showRegister() {
            loginView.classList.add('hidden');
            registerView.classList.remove('hidden');
            dashboardView.classList.add('hidden');
            loadDepartments();
        }

        function showDashboard() {
            if (!currentStudent) return;
            document.getElementById('welcomeName').textContent = currentStudent.name;
            
            // Show link info if available
            const linkInfo = document.getElementById('link-info');
            if (linkParams.lecture) {
                linkInfo.textContent = `Marking attendance for Lecture: ${linkParams.lecture} (${linkParams.date})`;
                linkInfo.classList.remove('hidden');
            } else {
                linkInfo.classList.add('hidden');
            }

            loginView.classList.add('hidden');
            registerView.classList.add('hidden');
            dashboardView.classList.remove('hidden');
        }

        function logout() {
            currentStudent = null;
            localStorage.removeItem('currentStudent');
            // Also clear link params on logout
            linkParams = {};
            // Go back to the login screen without any URL parameters
            window.location.href = window.location.pathname;
        }

        // --- REGISTRATION ---
        async function loadDepartments() {
            const departmentSelect = document.getElementById('department');
            departmentSelect.innerHTML = '<option value="">Select Department</option>';
            const snapshot = await getDocs(departmentsCollection);
            snapshot.forEach(doc => {
                const option = document.createElement('option');
                option.value = doc.data().name;
                option.textContent = doc.data().name;
                departmentSelect.appendChild(option);
            });
        }

        document.getElementById('registerForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const name = document.getElementById('name').value;
            const prn = document.getElementById('prn_register').value;
            const mobile = document.getElementById('mobile_register').value;
            const email = document.getElementById('email').value;
            const division = document.getElementById('division').value;
            const department = document.getElementById('department').value;
            const studentClass = document.getElementById('class').value;

            // Check if PRN already exists
            const q = query(studentsCollection, where("prn", "==", prn));
            const querySnapshot = await getDocs(q);
            if (!querySnapshot.empty) {
                alert('A student with this PRN already exists.');
                return;
            }

            await addDoc(studentsCollection, { name, prn, mobile, email, division, department, class: studentClass });
            alert('Registration successful! Please login.');
            showLogin();
        });

        // --- LOGIN ---
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const prn = document.getElementById('prn_login').value;
            const mobile = document.getElementById('mobile_login').value;

            const q = query(studentsCollection, where("prn", "==", prn), where("mobile", "==", mobile));
            const querySnapshot = await getDocs(q);

            if (querySnapshot.empty) {
                document.getElementById('login-error').textContent = 'Invalid PRN or Mobile Number.';
            } else {
                currentStudent = { id: querySnapshot.docs[0].id, ...querySnapshot.docs[0].data() };
                localStorage.setItem('currentStudent', JSON.stringify(currentStudent));
                showDashboard();
            }
        });

        // --- ATTENDANCE ---
        document.getElementById('markAttendanceBtn').addEventListener('click', async () => {
            if (!currentStudent) {
                alert("You are not logged in.");
                return;
            }
            if (!linkParams.teacherId) {
                alert("Please use a valid attendance link provided by your teacher.");
                return;
            }

            const btn = document.getElementById('markAttendanceBtn');
            btn.disabled = true;
            btn.textContent = 'Marking...';

            try {
                const position = await new Promise((resolve, reject) => {
                    navigator.geolocation.getCurrentPosition(resolve, reject, {
                        enableHighAccuracy: true,
                        timeout: 10000,
                        maximumAge: 0
                    });
                });

                const { latitude, longitude } = position.coords;
                const locationName = await getReverseGeocode(latitude, longitude);

                const attendanceRecord = {
                    studentId: currentStudent.id,
                    studentName: currentStudent.name,
                    prn: currentStudent.prn,
                    division: currentStudent.division,
                    department: currentStudent.department,
                    class: currentStudent.class,
                    timestamp: new Date(),
                    location: { lat: latitude, lon: longitude },
                    locationName: locationName,
                    teacherId: linkParams.teacherId,
                    lecture: linkParams.lecture,
                    lectureDate: linkParams.date
                };

                await addDoc(attendanceCollection, attendanceRecord);

                document.getElementById('successMessage').classList.remove('hidden');
                setTimeout(() => document.getElementById('successMessage').classList.add('hidden'), 4000);

            } catch (error) {
                console.error("Attendance marking failed:", error);
                let errorMessage = "Could not mark attendance. ";
                if (error.code === 1) errorMessage += "Please allow location access.";
                else errorMessage += "Please try again.";
                alert(errorMessage);
            } finally {
                btn.disabled = false;
                btn.textContent = 'Mark My Attendance';
            }
        });

        async function getReverseGeocode(lat, lon) {
            try {
                // Using a free, no-key-required reverse geocoding service
                const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}`);
                const data = await response.json();
                return data.display_name || 'Location details unavailable';
            } catch (error) {
                console.error('Reverse geocoding failed:', error);
                return 'Could not fetch location name';
            }
        }

    </script>
</head>
<body class="gradient-bg text-white min-h-screen flex items-center justify-center p-4 font-sans">

    <div class="w-full max-w-md mx-auto">
        <!-- Login View -->
        <div id="loginView">
            <div class="bg-white/20 backdrop-blur-lg p-8 rounded-2xl shadow-2xl text-center">
                <h1 class="text-4xl font-bold mb-6">Student Login</h1>
                <form id="loginForm" class="space-y-4">
                    <input id="prn_login" type="text" placeholder="PRN Number" required class="w-full bg-white/30 placeholder-white/70 text-white p-3 rounded-lg border-2 border-transparent focus:border-white focus:outline-none">
                    <input id="mobile_login" type="password" placeholder="Password (Your Mobile No.)" required class="w-full bg-white/30 placeholder-white/70 text-white p-3 rounded-lg border-2 border-transparent focus:border-white focus:outline-none">
                    <button type="submit" class="w-full bg-white text-blue-600 font-bold py-3 px-4 rounded-lg hover:bg-gray-200">Login</button>
                </form>
                <div id="login-error" class="mt-4 text-yellow-300 font-semibold"></div>
                <p class="mt-6">Don't have an account? <a href="#" id="showRegister" class="font-bold underline">Register here</a></p>
            </div>
        </div>

        <!-- Register View -->
        <div id="registerView" class="hidden">
            <div class="bg-white/20 backdrop-blur-lg p-8 rounded-2xl shadow-2xl">
                <h1 class="text-3xl font-bold mb-4 text-center">Student Registration</h1>
                <form id="registerForm" class="space-y-3 overflow-y-auto max-h-[70vh] p-2">
                    <input id="name" type="text" placeholder="Full Name" required class="w-full bg-white/30 placeholder-white/70 p-3 rounded-lg focus:outline-none">
                    <input id="prn_register" type="text" placeholder="PRN Number" required class="w-full bg-white/30 placeholder-white/70 p-3 rounded-lg focus:outline-none">
                    <input id="mobile_register" type="tel" placeholder="Mobile Number" required class="w-full bg-white/30 placeholder-white/70 p-3 rounded-lg focus:outline-none">
                    <input id="email" type="email" placeholder="Email Address" required class="w-full bg-white/30 placeholder-white/70 p-3 rounded-lg focus:outline-none">
                    <select id="division" required class="w-full bg-white/30 p-3 rounded-lg focus:outline-none">
                        <option value="">Select Division</option>
                        <option value="A">Division A</option>
                        <option value="B">Division B</option>
                        <option value="C">Division C</option>
                    </select>
                    <select id="department" required class="w-full bg-white/30 p-3 rounded-lg focus:outline-none">
                        <option value="">Loading Departments...</option>
                    </select>
                    <select id="class" required class="w-full bg-white/30 p-3 rounded-lg focus:outline-none">
                        <option value="">Select Class</option>
                        <option value="FY BTech">FY BTech</option>
                        <option value="SY BTech">SY BTech</option>
                        <option value="TY BTech">TY BTech</option>
                        <option value="BTech">BTech</option>
                    </select>
                    <button type="submit" class="w-full bg-white text-blue-600 font-bold py-3 px-4 rounded-lg hover:bg-gray-200">Register</button>
                </form>
                <p class="mt-4 text-center">Already have an account? <a href="#" id="showLogin" class="font-bold underline">Login here</a></p>
            </div>
        </div>

        <!-- Dashboard View -->
        <div id="dashboardView" class="hidden">
             <div class="bg-white/20 backdrop-blur-lg p-8 rounded-2xl shadow-2xl text-center">
                <h1 class="text-4xl font-bold">Welcome,</h1>
                <h2 id="welcomeName" class="text-2xl mb-6">Student</h2>
                <p id="link-info" class="mb-4 bg-white/20 p-2 rounded-md hidden"></p>
                <button id="markAttendanceBtn" class="w-full bg-white text-blue-600 font-bold py-4 px-4 rounded-lg text-lg hover:bg-gray-200 disabled:opacity-50">Mark My Attendance</button>
                <div id="successMessage" class="hidden mt-4 p-3 bg-green-500 rounded-lg">Attendance marked successfully!</div>
                <button id="logoutButton" class="mt-6 text-white/80 underline">Logout</button>
            </div>
        </div>
    </div>

</body>
</html>

