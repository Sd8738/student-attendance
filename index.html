<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Attendance</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="manifest" href="manifest.json">
    <style>
        .gradient-bg {
            background: linear-gradient(-45deg, #ee7752, #e73c7e, #23a6d5, #23d5ab);
            background-size: 400% 400%;
            animation: gradient 15s ease infinite;
        }
        @keyframes gradient {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        .hidden { display: none; }
    </style>
</head>
<body class="bg-gray-100 font-sans">

    <!-- Main Container -->
    <div id="app" class="max-w-md mx-auto bg-white min-h-screen shadow-lg">

        <!-- Login View -->
        <div id="loginView" class="p-8">
            <h1 class="text-3xl font-bold text-center text-gray-800 mb-6" data-en="Student Login" data-mr="विद्यार्थी लॉगिन">Student Login</h1>
            <form id="loginForm" class="space-y-4">
                <div>
                    <label for="prnLogin" class="block text-sm font-medium text-gray-700" data-en="PRN Number" data-mr="पीआरएन क्रमांक">PRN Number</label>
                    <input type="text" id="prnLogin" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-orange-500 focus:border-orange-500">
                </div>
                <div>
                    <label for="passwordLogin" class="block text-sm font-medium text-gray-700" data-en="Password (Registered Mobile No.)" data-mr="पासवर्ड (नोंदणीकृत मोबाइल क्र.)">Password (Registered Mobile No.)</label>
                    <input type="password" id="passwordLogin" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-orange-500 focus:border-orange-500">
                </div>
                <button type="submit" class="w-full bg-orange-500 text-white font-bold py-3 px-4 rounded-lg hover:bg-orange-600" data-en="Login" data-mr="लॉगिन करा">Login</button>
            </form>
            <p id="login-error-message" class="mt-4 text-center text-red-600 font-semibold"></p>
            <p class="mt-4 text-center text-sm">
                <span data-en="Don't have an account? " data-mr="खाते नाही? ">Don't have an account? </span>
                <a href="#" id="showRegisterView" class="font-medium text-orange-600 hover:text-orange-500" data-en="Register here" data-mr="येथे नोंदणी करा">Register here</a>
            </p>
        </div>

        <!-- Registration View -->
        <div id="registerView" class="p-8 hidden">
             <h1 class="text-3xl font-bold text-center text-gray-800 mb-6" data-en="Student Registration" data-mr="विद्यार्थी नोंदणी">Student Registration</h1>
            <form id="registerForm" class="space-y-4">
                <input type="text" id="name" placeholder="Name" data-en-placeholder="Name" data-mr-placeholder="नाव" required class="w-full px-3 py-2 border rounded">
                <input type="text" id="prn" placeholder="PRN Number" data-en-placeholder="PRN Number" data-mr-placeholder="पीआरएन क्रमांक" required class="w-full px-3 py-2 border rounded">
                <input type="tel" id="phone" placeholder="Mobile Number" data-en-placeholder="Mobile Number" data-mr-placeholder="मोबाईल नंबर" required class="w-full px-3 py-2 border rounded">
                <input type="email" id="email" placeholder="Email Address" data-en-placeholder="Email Address" data-mr-placeholder="ई-मेल ऍड्रेस" required class="w-full px-3 py-2 border rounded">
                 <select id="department" required class="w-full px-3 py-2 border rounded bg-white">
                    <option value="" data-en="Select Department" data-mr="विभाग निवडा">Select Department</option>
                </select>
                <select id="class" required class="w-full px-3 py-2 border rounded bg-white">
                    <option value="" data-en="Select Class" data-mr="वर्ग निवडा">Select Class</option>
                    <option value="FY BTech">FY BTech</option>
                    <option value="SY BTech">SY BTech</option>
                    <option value="TY BTech">TY BTech</option>
                    <option value="BTech">BTech</option>
                </select>
                <input type="text" id="division" placeholder="Division (e.g., A, B)" data-en-placeholder="Division (e.g., A, B)" data-mr-placeholder="तुकडी (उदा. अ, ब)" required class="w-full px-3 py-2 border rounded">
                <button type="submit" class="w-full bg-orange-500 text-white font-bold py-3 px-4 rounded-lg hover:bg-orange-600" data-en="Register" data-mr="नोंदणी करा">Register</button>
            </form>
            <p id="register-message" class="mt-4 text-center font-semibold"></p>
            <p class="mt-4 text-center text-sm">
                <span data-en="Already have an account? " data-mr="आधीपासूनच खाते आहे? ">Already have an account? </span>
                <a href="#" id="showLoginView" class="font-medium text-orange-600 hover:text-orange-500" data-en="Login here" data-mr="येथे लॉगिन करा">Login here</a>
            </p>
        </div>

        <!-- Dashboard View -->
        <div id="dashboardView" class="hidden">
            <div class="gradient-bg text-white p-8 rounded-b-3xl">
                <div class="flex justify-between items-center">
                    <div>
                        <h1 class="text-3xl font-bold" data-en="Dashboard" data-mr="डॅशबोर्ड">Dashboard</h1>
                        <p id="welcomeMessage"></p>
                    </div>
                    <button id="logoutButton" class="bg-white/20 px-3 py-1 rounded-lg text-sm" data-en="Logout" data-mr="लॉगआउट">Logout</button>
                </div>
            </div>
            <div class="p-8 text-center">
                 <div id="linkInfo" class="mb-6 bg-orange-100 p-4 rounded-lg border border-orange-200">
                    <p class="text-gray-700">
                        <strong data-en="Attendance for:" data-mr="यासाठी उपस्थिती:">Attendance for:</strong>
                        <span id="linkDetails"></span>
                    </p>
                </div>
                <button id="markAttendance" class="w-full bg-orange-500 text-white font-extrabold py-6 rounded-2xl text-2xl shadow-lg hover:bg-orange-600" data-en="MARK MY ATTENDANCE" data-mr="माझी उपस्थिती लावा">MARK MY ATTENDANCE</button>
                <div id="message" class="mt-4 p-4 rounded-lg hidden"></div>
            </div>
        </div>

        <!-- Footer for language toggle -->
        <div id="footer" class="p-4 text-center">
             <button id="langToggle" class="px-4 py-2 bg-gray-200 rounded-lg">Switch to Marathi</button>
        </div>
    </div>
    
    <!-- Camera Modal -->
    <div id="cameraModal" class="hidden fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center p-4">
        <div class="bg-white rounded-lg text-center p-6">
            <h2 class="text-xl font-bold mb-4" data-en="Taking Photo..." data-mr="फोटो घेत आहे...">Taking Photo...</h2>
            <p class="text-gray-600" data-en="Please look at the camera." data-mr="कृपया कॅमेराकडे पहा.">Please look at the camera.</p>
            <div class="w-64 h-48 bg-gray-200 my-4 mx-auto rounded-lg overflow-hidden">
                <video id="video" class="w-full h-full object-cover" autoplay></video>
            </div>
        </div>
    </div>

    <!-- Firebase -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, addDoc, query, where, getDocs, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        const firebaseConfig = {
            apiKey: "AIzaSyAOFDLOYDRdSZfwprsvs_ena_3X2D0BHjw",
            authDomain: "student-management-syste-27e33.firebaseapp.com",
            projectId: "student-management-syste-27e33",
            storageBucket: "student-management-syste-27e33.appspot.com",
            messagingSenderId: "536854876751",
            appId: "1:536854876751:web:adf88ef74dfc76cea903a",
            measurementId: "G-FKZJL4HLZZ"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        const studentsCollection = collection(db, "students");
        const departmentsCollection = collection(db, "departments");
        const teachersCollection = collection(db, "teachers");

        // --- GLOBAL STATE ---
        let currentLanguage = 'en';
        let currentUser = null;
        let allTeachers = {};

        // --- VIEWS ---
        const loginView = document.getElementById('loginView');
        const registerView = document.getElementById('registerView');
        const dashboardView = document.getElementById('dashboardView');
        const footer = document.getElementById('footer');

        // --- UI ELEMENTS ---
        const langToggle = document.getElementById('langToggle');
        const welcomeMessage = document.getElementById('welcomeMessage');
        const markAttendanceBtn = document.getElementById('markAttendance');

        // --- LANGUAGE DATA ---
        const translations = {
            'mr': {
                'Switch to English': 'इंग्रजीमध्ये बदला',
                'Switch to Marathi': 'मराठीमध्ये बदला',
            }
        };

        // --- FUNCTIONS ---
        function setLanguage(lang) {
            currentLanguage = lang;
            document.querySelectorAll('[data-en]').forEach(el => {
                const text = el.getAttribute(`data-${lang}`);
                if (el.tagName === 'INPUT' || el.tagName === 'SELECT') {
                    if (el.placeholder) el.placeholder = text;
                } else {
                    el.textContent = text;
                }
            });
            langToggle.textContent = lang === 'en' ? translations.mr['Switch to Marathi'] : translations.mr['Switch to English'];
        }

        langToggle.addEventListener('click', () => {
            setLanguage(currentLanguage === 'en' ? 'mr' : 'en');
        });
        
        function showView(view) {
            loginView.classList.add('hidden');
            registerView.classList.add('hidden');
            dashboardView.classList.add('hidden');
            footer.classList.remove('hidden');
            view.classList.remove('hidden');
            if (view === dashboardView) {
                footer.classList.add('hidden');
            }
        }

        function showMessage(type, title, text) {
            const messageDiv = document.getElementById('message');
            messageDiv.className = `mt-4 p-4 rounded-lg ${type === 'success' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}`;
            messageDiv.innerHTML = `<strong class="font-bold">${title}</strong><br>${text}`;
            messageDiv.classList.remove('hidden');
        }

        // --- PAGE LOAD LOGIC ---
        window.addEventListener('DOMContentLoaded', async () => {
            // Fetch teachers for link info display
            onSnapshot(collection(db, "teachers"), snapshot => {
                snapshot.forEach(doc => allTeachers[doc.id] = doc.data());
            });

            // Check for link parameters
            const params = new URLSearchParams(window.location.search);
            const teacherId = params.get('teacherId');
            const lecture = params.get('lecture');
            const date = params.get('date');

            if (teacherId && lecture && date) {
                sessionStorage.setItem('attendanceLinkData', JSON.stringify({ teacherId, lecture, date }));
            }

            // Check if user is already logged in (from sessionStorage)
            const loggedInUser = sessionStorage.getItem('currentUser');
            if (loggedInUser) {
                currentUser = JSON.parse(loggedInUser);
                setupDashboard();
            } else {
                showView(loginView);
            }
        });

        function setupDashboard() {
            welcomeMessage.textContent = `${currentUser.name} (PRN: ${currentUser.prn})`;
            
            const linkDataString = sessionStorage.getItem('attendanceLinkData');
            if(linkDataString) {
                const linkData = JSON.parse(linkDataString);
                const teacher = allTeachers[linkData.teacherId];
                const teacherName = teacher ? teacher.name : "Unknown Teacher";
                document.getElementById('linkDetails').textContent = `Lecture ${linkData.lecture} on ${linkData.date} for ${teacherName}`;
                document.getElementById('linkInfo').classList.remove('hidden');
                markAttendanceBtn.disabled = false;
            } else {
                document.getElementById('linkDetails').textContent = 'Please use a valid attendance link.';
                document.getElementById('linkInfo').classList.remove('hidden');
                markAttendanceBtn.disabled = true;
            }
            showView(dashboardView);
        }

        // --- EVENT LISTENERS ---
        document.getElementById('showRegisterView').addEventListener('click', (e) => {
            e.preventDefault();
            loadDepartmentsForRegistration();
            showView(registerView);
        });

        document.getElementById('showLoginView').addEventListener('click', (e) => {
            e.preventDefault();
            showView(loginView);
        });

        document.getElementById('logoutButton').addEventListener('click', () => {
            currentUser = null;
            sessionStorage.removeItem('currentUser');
            sessionStorage.removeItem('attendanceLinkData');
            window.location.search = ''; // Clear URL params on logout
            showView(loginView);
        });

        async function loadDepartmentsForRegistration() {
            const departmentSelect = document.getElementById('department');
            departmentSelect.innerHTML = '<option value="">Select Department</option>';
            const snapshot = await getDocs(departmentsCollection);
            snapshot.forEach(doc => {
                const option = document.createElement('option');
                option.value = doc.data().name;
                option.textContent = doc.data().name;
                departmentSelect.appendChild(option);
            });
        }
        
        // --- FORM SUBMISSIONS ---
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const prn = document.getElementById('prnLogin').value;
            const password = document.getElementById('passwordLogin').value;
            const errorEl = document.getElementById('login-error-message');
            errorEl.textContent = '';
            
            const q = query(studentsCollection, where("prn", "==", prn), where("phone", "==", password));
            const querySnapshot = await getDocs(q);

            if (querySnapshot.empty) {
                errorEl.textContent = "Invalid PRN or password.";
            } else {
                currentUser = { id: querySnapshot.docs[0].id, ...querySnapshot.docs[0].data() };
                sessionStorage.setItem('currentUser', JSON.stringify(currentUser));
                setupDashboard();
            }
        });

        document.getElementById('registerForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const messageEl = document.getElementById('register-message');
            const studentData = {
                name: document.getElementById('name').value,
                prn: document.getElementById('prn').value,
                phone: document.getElementById('phone').value,
                email: document.getElementById('email').value,
                department: document.getElementById('department').value,
                class: document.getElementById('class').value,
                division: document.getElementById('division').value,
            };

            // Check if PRN already exists
            const q = query(studentsCollection, where("prn", "==", studentData.prn));
            const snapshot = await getDocs(q);
            if (!snapshot.empty) {
                messageEl.textContent = "A student with this PRN already exists.";
                messageEl.className = 'mt-4 text-center font-semibold text-red-600';
                return;
            }

            try {
                await addDoc(studentsCollection, studentData);
                messageEl.textContent = "Registration successful! Please login.";
                messageEl.className = 'mt-4 text-center font-semibold text-green-600';
                document.getElementById('registerForm').reset();
                setTimeout(() => showView(loginView), 2000);
            } catch (error) {
                messageEl.textContent = "Registration failed. Please try again.";
                messageEl.className = 'mt-4 text-center font-semibold text-red-600';
            }
        });

        // --- ATTENDANCE LOGIC ---
        markAttendanceBtn.addEventListener('click', async () => {
            const linkDataString = sessionStorage.getItem('attendanceLinkData');
            if (!linkDataString) {
                showMessage('error', 'Invalid Link', 'Please mark attendance using a valid link from your teacher.');
                return;
            }
            
            markAttendanceBtn.disabled = true;
            markAttendanceBtn.textContent = 'Processing...';

            try {
                const { coords } = await new Promise((resolve, reject) => navigator.geolocation.getCurrentPosition(resolve, reject));
                const location = { lat: coords.latitude, lon: coords.longitude };
                
                const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${location.lat}&lon=${location.lon}`);
                const data = await response.json();
                const locationName = data.display_name || "Location unavailable";

                const cameraModal = document.getElementById('cameraModal');
                cameraModal.classList.remove('hidden');
                
                const stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: false });
                document.getElementById('video').srcObject = stream;

                setTimeout(async () => {
                    stream.getTracks().forEach(track => track.stop());
                    cameraModal.classList.add('hidden');
                    
                    const linkData = JSON.parse(linkDataString);

                    const attendanceRecord = {
                        ...currentUser,
                        location,
                        locationName,
                        teacherId: linkData.teacherId,
                        lecture: linkData.lecture,
                        lectureDate: linkData.date,
                        timestamp: new Date()
                    };

                    await addDoc(collection(db, "attendance"), attendanceRecord);
                    
                    showMessage('success', 'Success!', 'Your attendance has been marked.');
                    sessionStorage.removeItem('attendanceLinkData');
                    markAttendanceBtn.textContent = 'ATTENDANCE MARKED';

                }, 2000);

            } catch (error) {
                console.error("Attendance Error:", error);
                let errorMessage = 'Could not mark attendance. Please try again.';
                if (error.code === 1) { // PERMISSION_DENIED
                    errorMessage = 'Location and Camera access are required. Please enable them in your browser settings.';
                }
                showMessage('error', 'Error', errorMessage);
                markAttendanceBtn.disabled = false;
                markAttendanceBtn.textContent = 'MARK MY ATTENDANCE';
            }
        });
        
    </script>
</body>
</html>

