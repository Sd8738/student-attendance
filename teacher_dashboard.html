<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Personalized Teacher Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Firebase Libraries -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, onSnapshot, query, where, getDocs, doc, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAOFDLOYDRdSZfwprsvs_ena_3X2D0BHjw",
            authDomain: "student-management-syste-27e33.firebaseapp.com",
            projectId: "student-management-syste-27e33",
            storageBucket: "student-management-syste-27e33.appspot.com",
            messagingSenderId: "536854876751",
            appId: "1:536854876751:web:adf88ef74dfc76cea903a",
            measurementId: "G-FKZJL4HLZZ"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        let allAttendanceRecords = [];
        let allTeachers = {}; 
        let attendanceChart = null;
        let currentTeacher = null;

        const loginView = document.getElementById('loginView');
        const dashboardView = document.getElementById('dashboardView');
        const loginForm = document.getElementById('teacherLoginForm');
        const loginError = document.getElementById('login-error-message');

        // --- COLLECTIONS ---
        const teachersCollection = collection(db, "teachers");
        const departmentsCollection = collection(db, "departments");
        const attendanceCollection = collection(db, "attendance");

        // --- PAGE LOAD LOGIC ---
        window.addEventListener('DOMContentLoaded', () => {
            onSnapshot(teachersCollection, (snapshot) => {
                allTeachers = {};
                snapshot.forEach((doc) => {
                    allTeachers[doc.id] = { id: doc.id, ...doc.data()};
                });
            });
            
            const loggedInTeacher = localStorage.getItem('currentTeacher');
            if(loggedInTeacher) {
                currentTeacher = JSON.parse(loggedInTeacher);
                showDashboard();
            } else {
                showLogin();
            }
        });

        function showLogin() {
            loginView.classList.remove('hidden');
            dashboardView.classList.add('hidden');
        }

        function showDashboard() {
            document.getElementById('welcomeTeacherName').innerText = currentTeacher.name;
            loginView.classList.add('hidden');
            dashboardView.classList.remove('hidden');
            loadPersonalizedData();
        }

        document.getElementById('logoutButton').addEventListener('click', () => {
            localStorage.removeItem('currentTeacher');
            currentTeacher = null;
            showLogin();
        });
        
        // --- LOGIN LOGIC ---
        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            loginError.textContent = '';
            const name = document.getElementById('teacherName').value.trim();
            const subject = document.getElementById('teacherSubject').value.trim();

            const q = query(teachersCollection, where("name", "==", name), where("subject", "==", subject));
            const querySnapshot = await getDocs(q);

            if (querySnapshot.empty) {
                loginError.textContent = "Invalid name or subject. Please try again.";
            } else {
                currentTeacher = {id: querySnapshot.docs[0].id, ...querySnapshot.docs[0].data()};
                localStorage.setItem('currentTeacher', JSON.stringify(currentTeacher));
                showDashboard();
            }
        });

        function loadPersonalizedData() {
            if (!currentTeacher) return;
            
            // --- Attendance Control Panel ---
            const permanentLinkInput = document.getElementById('permanentLink');
            const relativeURL = 'index.html';
            const params = new URLSearchParams({ teacherId: currentTeacher.id });
            const currentPath = window.location.href;
            const basePath = currentPath.substring(0, currentPath.lastIndexOf('/') + 1);
            permanentLinkInput.value = `${basePath}${relativeURL}?${params.toString()}`;

            const toggle = document.getElementById('attendanceToggle');
            const lectureInput = document.getElementById('currentLecture');
            const dateInput = document.getElementById('currentLectureDate');
            
            // Listen for real-time updates to this teacher's document
            onSnapshot(doc(db, "teachers", currentTeacher.id), (docSnap) => {
                if (docSnap.exists()) {
                    const teacherData = docSnap.data();
                    toggle.checked = teacherData.isAcceptingAttendance;
                    lectureInput.value = teacherData.currentLecture || '';
                    dateInput.value = teacherData.currentLectureDate || new Date().toISOString().split('T')[0];
                    lectureInput.disabled = toggle.checked;
                    dateInput.disabled = toggle.checked;
                }
            });
            
            // Fetch departments for the filter dropdown
            onSnapshot(departmentsCollection, (snapshot) => {
                const departmentFilter = document.getElementById('departmentFilter');
                departmentFilter.innerHTML = '<option value="all">All Departments</option>';
                snapshot.forEach((doc) => {
                    const department = { id: doc.id, ...doc.data() };
                    const option = document.createElement('option');
                    option.value = department.name;
                    option.textContent = department.name;
                    departmentFilter.appendChild(option);
                });
            });

            // Fetch attendance records for this specific teacher
            const q = query(attendanceCollection, where("teacherId", "==", currentTeacher.id));
            onSnapshot(q, (querySnapshot) => {
                allAttendanceRecords = [];
                querySnapshot.forEach((doc) => {
                    allAttendanceRecords.push({ id: doc.id, ...doc.data() });
                });
                // Manual sort because composite indexes can be complex to set up
                allAttendanceRecords.sort((a, b) => b.timestamp.toDate() - a.timestamp.toDate());
                filterRecords();
            });
        }
        
        function renderAttendance(records) {
            const attendanceList = document.getElementById('attendanceList');
            const placeholder = document.getElementById('detailsPlaceholder');
            const studentDetails = document.getElementById('studentDetails');
            attendanceList.innerHTML = '';

            if (records.length === 0) {
                attendanceList.innerHTML = '<p class="text-gray-500">No attendance records match the current filter.</p>';
                placeholder.classList.remove('hidden');
                studentDetails.classList.add('hidden');
                return;
            }

            records.forEach(record => {
                const recordDiv = document.createElement('div');
                recordDiv.className = 'p-3 mb-2 bg-gray-50 rounded-lg cursor-pointer hover:bg-orange-100 border border-gray-200';
                recordDiv.innerHTML = `<h4 class="font-semibold text-gray-800">${record.studentName}</h4><p class="text-sm text-gray-500">Div: ${record.division} | ${new Date(record.timestamp.toDate()).toLocaleString()}</p>`;
                recordDiv.onclick = () => showDetails(record.id);
                attendanceList.appendChild(recordDiv);
            });
        }

        window.showDetails = function(recordId) {
            const record = allAttendanceRecords.find(r => r.id === recordId);
            if (!record) return;
            
            document.getElementById('detailName').innerText = record.studentName;
            document.getElementById('detailPrn').innerText = record.prn || 'N/A';
            document.getElementById('detailDepartment').innerText = record.department || 'N/A';
            document.getElementById('detailClass').innerText = record.class || 'N/A';
            document.getElementById('detailLecture').innerText = record.lecture || 'N/A';
            document.getElementById('detailLectureDate').innerText = record.lectureDate || 'N/A';
            document.getElementById('detailTime').innerText = new Date(record.timestamp.toDate()).toLocaleString();
            document.getElementById('detailLocation').innerHTML = `<a href="https://www.google.com/maps?q=${record.location.lat},${record.location.lon}" target="_blank" class="text-orange-500 hover:underline">${record.locationName || 'View on Map'}</a>`;
            document.getElementById('detailDivision').innerText = record.division;
            
            const teacher = allTeachers[record.teacherId];
            document.getElementById('detailTeacher').innerText = teacher ? `${teacher.name} (${teacher.subject})` : 'Unknown';
            
            // NEW: Set up the delete button
            const deleteBtn = document.getElementById('deleteAttendanceBtn');
            deleteBtn.onclick = () => deleteAttendance(record.id);

            document.getElementById('detailsPlaceholder').classList.add('hidden');
            document.getElementById('studentDetails').classList.remove('hidden');
        }

        // NEW: Function to delete an attendance record
        async function deleteAttendance(recordId) {
            if (confirm('Are you sure you want to permanently delete this attendance record?')) {
                try {
                    await deleteDoc(doc(db, "attendance", recordId));
                    // Hide details view and show placeholder
                    document.getElementById('detailsPlaceholder').classList.remove('hidden');
                    document.getElementById('studentDetails').classList.add('hidden');
                    alert('Attendance record deleted successfully.');
                } catch (error) {
                    console.error("Error deleting attendance: ", error);
                    alert('Failed to delete the record. Please try again.');
                }
            }
        }

        function updateAnalytics(records) {
            const ctx = document.getElementById('attendanceChart').getContext('2d');
            const attendanceByDay = {};

            records.forEach(record => {
                const date = new Date(record.timestamp.toDate()).toLocaleDateString();
                attendanceByDay[date] = (attendanceByDay[date] || 0) + 1;
            });

            const labels = Object.keys(attendanceByDay).sort((a,b) => new Date(a.split('/').reverse().join('-')) - new Date(b.split('/').reverse().join('-')));
            const data = labels.map(label => attendanceByDay[label]);

            if(attendanceChart) {
                attendanceChart.destroy();
            }

            attendanceChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Students Present',
                        data: data,
                        backgroundColor: 'rgba(249, 115, 22, 0.6)',
                        borderColor: 'rgba(249, 115, 22, 1)',
                        borderWidth: 1
                    }]
                },
                options: { scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } } }
            });
        }

        function filterRecords() {
            const selectedDivision = document.getElementById('divisionFilter').value;
            const selectedDepartment = document.getElementById('departmentFilter').value;
            const selectedClass = document.getElementById('classFilter').value;
            
            let filteredRecords = allAttendanceRecords;

            if (selectedDivision !== 'all') {
                filteredRecords = filteredRecords.filter(r => r.division === selectedDivision);
            }
            if (selectedDepartment !== 'all') {
                filteredRecords = filteredRecords.filter(r => r.department === selectedDepartment);
            }
            if (selectedClass !== 'all') {
                filteredRecords = filteredRecords.filter(r => r.class === selectedClass);
            }
            renderAttendance(filteredRecords);
            updateAnalytics(filteredRecords);
        }
        
        window.filterRecords = filterRecords;

        // --- EXPORT TO CSV FUNCTIONALITY ---
        document.getElementById('exportButton').addEventListener('click', () => {
            let recordsToExport = allAttendanceRecords;
            const selectedDivision = document.getElementById('divisionFilter').value;
            const selectedDepartment = document.getElementById('departmentFilter').value;
            const selectedClass = document.getElementById('classFilter').value;

            if (selectedDivision !== 'all') recordsToExport = recordsToExport.filter(r => r.division === selectedDivision);
            if (selectedDepartment !== 'all') recordsToExport = recordsToExport.filter(r => r.department === selectedDepartment);
            if (selectedClass !== 'all') recordsToExport = recordsToExport.filter(r => r.class === selectedClass);

            if (recordsToExport.length === 0) {
                alert("No data to export for the current selection.");
                return;
            }

            const headers = ["Student Name", "PRN", "Department", "Class", "Division", "Marked Date", "Marked Time", "Lecture Number", "Lecture Date", "Location"];
            const rows = recordsToExport.map(record => {
                const timestamp = record.timestamp.toDate();
                const sanitize = (str) => `"${(str || '').toString().replace(/"/g, '""')}"`;

                return [
                    sanitize(record.studentName), sanitize(record.prn), sanitize(record.department),
                    sanitize(record.class), sanitize(record.division), timestamp.toLocaleDateString(),
                    timestamp.toLocaleTimeString(), sanitize(record.lecture), sanitize(record.lectureDate),
                    sanitize(record.locationName)
                ].join(',');
            });

            const csvContent = [headers.join(','), ...rows].join('\n');
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            const url = URL.createObjectURL(blob);
            const filename = `attendance_${currentTeacher.name.replace(' ','_')}_${new Date().toISOString().split('T')[0]}.csv`;
            link.setAttribute("href", url);
            link.setAttribute("download", filename);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        });

        // --- ATTENDANCE CONTROL LOGIC ---
        document.getElementById('attendanceToggle').addEventListener('change', async (e) => {
            const isChecked = e.target.checked;
            const lecture = document.getElementById('currentLecture').value;
            const date = document.getElementById('currentLectureDate').value;

            if (isChecked && (!lecture || !date)) {
                alert('Please enter a lecture number and date before starting.');
                e.target.checked = false;
                return;
            }
            
            const teacherRef = doc(db, "teachers", currentTeacher.id);
            await updateDoc(teacherRef, {
                isAcceptingAttendance: isChecked,
                currentLecture: isChecked ? lecture : '',
                currentLectureDate: isChecked ? date : ''
            });
        });
        
        document.getElementById('copyLinkButton').addEventListener('click', () => {
            const linkInput = document.getElementById('permanentLink');
            linkInput.select();
            document.execCommand('copy');
            const btn = document.getElementById('copyLinkButton');
            btn.textContent = 'Copied!';
            setTimeout(() => { btn.textContent = 'Copy'; }, 2000);
        });

    </script>
     <style>
        /* Custom styles for the toggle switch */
        .toggle-checkbox:checked {
            right: 0;
            border-color: #F97316;
        }
        .toggle-checkbox:checked + .toggle-label {
            background-color: #F97316;
        }
    </style>
</head>
<body class="bg-gray-100 font-sans">

    <!-- Login View -->
    <div id="loginView" class="flex items-center justify-center min-h-screen p-4">
        <div class="w-full max-w-md mx-auto p-8 bg-white rounded-2xl shadow-2xl">
            <h1 class="text-3xl font-bold text-center text-gray-800 mb-6">Teacher Login</h1>
            <form id="teacherLoginForm" class="space-y-4">
                <div>
                    <label for="teacherName" class="block text-sm font-medium text-gray-700">Your Name</label>
                    <input type="text" id="teacherName" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-orange-500 focus:border-orange-500">
                </div>
                <div>
                    <label for="teacherSubject" class="block text-sm font-medium text-gray-700">Your Subject</label>
                    <input type="text" id="teacherSubject" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-orange-500 focus:border-orange-500">
                </div>
                <button type="submit" class="w-full bg-orange-500 text-white font-bold py-3 px-4 rounded-lg hover:bg-orange-600">Login</button>
            </form>
            <div id="login-error-message" class="mt-4 text-center text-red-600 font-semibold"></div>
        </div>
    </div>
    
    <!-- Dashboard View -->
    <div id="dashboardView" class="hidden container mx-auto p-4 md:p-8">
        <div class="flex justify-between items-center mb-6">
            <div>
                <h1 class="text-4xl font-bold text-gray-800 mb-2">Welcome, <span id="welcomeTeacherName"></span></h1>
                <p class="text-lg text-gray-600">Your Personal Attendance Dashboard</p>
            </div>
            <div>
                 <button id="logoutButton" class="bg-red-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-red-600">Logout</button>
            </div>
        </div>
        
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
             <div class="md:col-span-1">
                <label for="divisionFilter" class="block text-sm font-medium text-gray-700 mb-1">Filter by Division:</label>
                <select id="divisionFilter" onchange="filterRecords()" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-orange-500">
                    <option value="all">All Divisions</option>
                    <option value="A">Division A</option>
                    <option value="B">Division B</option>
                    <option value="C">Division C</option>
                </select>
            </div>
            <div class="md:col-span-1">
                <label for="departmentFilter" class="block text-sm font-medium text-gray-700 mb-1">Filter by Department:</label>
                <select id="departmentFilter" onchange="filterRecords()" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-orange-500">
                    <option value="all">All Departments</option>
                </select>
            </div>
             <div class="md:col-span-1">
                <label for="classFilter" class="block text-sm font-medium text-gray-700 mb-1">Filter by Class:</label>
                <select id="classFilter" onchange="filterRecords()" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-orange-500">
                    <option value="all">All Classes</option>
                    <option value="FY BTech">FY BTech</option>
                    <option value="SY BTech">SY BTech</option>
                    <option value="TY BTech">TY BTech</option>
                    <option value="BTech">BTech</option>
                </select>
            </div>
             <div class="md:col-span-1 text-center self-end">
                <button id="exportButton" class="w-full bg-green-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-green-700">
                    Export Filtered Data
                </button>
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
            <div class="md:col-span-1 bg-white rounded-2xl shadow-lg p-6">
                <h2 class="text-2xl font-bold text-gray-800 mb-4 border-b pb-2">Your Attendance Log</h2>
                <div id="attendanceList" class="max-h-[30rem] overflow-y-auto">
                    <p class="text-gray-500">Loading records...</p>
                </div>
            </div>

            <div class="md:col-span-2 bg-white rounded-2xl shadow-lg p-6">
                 <h2 class="text-2xl font-bold text-gray-800 mb-4 border-b pb-2">Attendance Details</h2>
                 <div id="detailsPlaceholder" class="text-center py-12">
                     <p class="text-gray-500">Select a record from the log to see details.</p>
                 </div>
                 <div id="studentDetails" class="hidden space-y-3">
                     <p><strong>Name:</strong> <span id="detailName"></span></p>
                     <p><strong>PRN Number:</strong> <span id="detailPrn"></span></p>
                     <p><strong>Department:</strong> <span id="detailDepartment"></span></p>
                     <p><strong>Class:</strong> <span id="detailClass"></span></p>
                     <p><strong>Marked For:</strong> <span id="detailTeacher"></span></p>
                     <p><strong>Division:</strong> <span id="detailDivision"></span></p>
                     <p><strong>Marked At:</strong> <span id="detailTime"></span></p>
                     <p><strong>Location:</strong> <span id="detailLocation"></span></p>
                     <p><strong>Lecture:</strong> <span id="detailLecture"></span></p>
                     <p><strong>Lecture Date:</strong> <span id="detailLectureDate"></span></p>
                     <!-- NEW: Delete button -->
                     <button id="deleteAttendanceBtn" class="!mt-6 w-full bg-red-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-red-600">Delete This Attendance Record</button>
                 </div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mt-8">
            <div class="bg-white rounded-2xl shadow-lg p-6">
                <h2 class="text-2xl font-bold text-gray-800 mb-4 border-b pb-2">Attendance Control</h2>
                 <div class="space-y-4">
                     <div>
                        <label class="block text-sm font-medium text-gray-700">Your Permanent Link</label>
                         <div class="flex mt-1">
                             <input type="text" id="permanentLink" readonly class="block w-full px-3 py-2 border border-gray-300 rounded-l-md bg-gray-100">
                             <button id="copyLinkButton" class="bg-gray-500 text-white font-bold py-2 px-4 rounded-r-lg hover:bg-gray-600">Copy</button>
                         </div>
                    </div>
                    <div>
                        <label for="currentLecture" class="block text-sm font-medium text-gray-700">Current Lecture Number/Name</label>
                        <input type="text" id="currentLecture" placeholder="e.g., 1, 2, Practical 3" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-orange-500 focus:border-orange-500 disabled:bg-gray-200">
                    </div>
                     <div>
                        <label for="currentLectureDate" class="block text-sm font-medium text-gray-700">Current Lecture Date</label>
                        <input type="date" id="currentLectureDate" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-orange-500 focus:border-orange-500 disabled:bg-gray-200">
                    </div>
                    <div class="flex items-center justify-between">
                         <span class="text-lg font-medium text-gray-900">Accepting Attendance</span>
                        <div class="relative inline-block w-14 mr-2 align-middle select-none transition duration-200 ease-in">
                            <input type="checkbox" name="toggle" id="attendanceToggle" class="toggle-checkbox absolute block w-7 h-7 rounded-full bg-white border-4 appearance-none cursor-pointer"/>
                            <label for="attendanceToggle" class="toggle-label block overflow-hidden h-7 rounded-full bg-gray-300 cursor-pointer"></label>
                        </div>
                    </div>
                </div>
            </div>
            <div class="bg-white rounded-2xl shadow-lg p-6">
                <h2 class="text-2xl font-bold text-gray-800 mb-4 border-b pb-2">Your Attendance Analytics</h2>
                <canvas id="attendanceChart"></canvas>
            </div>
        </div>
    </div>
</body>
</html>

